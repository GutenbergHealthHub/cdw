-- Table with icd to investigate
drop table if exists dativa_study1_icd cascade;

create table dativa_study1_icd(
  icd varchar
);

-- insert icd into table
insert into dativa_study1_icd values
('C88'),
('E10.1'),
('E10.6'),
('E10.7'),
('E10.8'),
('E10.9'),
('E11.0'),
('E11.1'),
('E11.6'),
('E11.7'),
('E11.8'),
('E11.9'),
('E12.0'),
('E12.1'),
('E12.6'),
('E12.7'),
('E12.8'),
('E12.9'),
('E13.0'),
('E13.1'),
('E13.6'),
('E13.7'),
('E13.8'),
('E13.9'),
('E14.0'),
('E14.1'),
('E14.6'),
('E14.7'),
('E14.8'),
('E14.9'),
('F05.1'),
('G11.4'),
('G30'),
('G31.1'),
('G46'),
('G80.1'),
('G80.2'),
('G81'),
('G82'),
('G83.0'),
('G83.9'),
('H34.0'),
('I11.0'),
('I13.0'),
('I13.1'),
('I13.2'),
('I25.5'),
('I27.9'),
('I42.0'),
('I43'),
('I50'),
('I71'),
('I73.1'),
('I73.8'),
('I73.9'),
('I77.1'),
('I79.0'),
('I79.2'),
('I85.9'),
('I86.4'),
('I98.2'),
('J40'),
('J41'),
('J42'),
('J43'),
('J44.19'),
('J44'),
('J45'),
('J46'),
('J46'),
('J47'),
('J68.4'),
('J70.1'),
('J70.3'),
('K55.1'),
('K55.8'),
('K55.9'),
('K70.4'),
('K70.9'),
('K71.1'),
('K71.3'),
('K72.1'),
('K72.9'),
('K73'),
('K74'),
('K76.0'),
('K76.5'),
('K76.6'),
('K76.7'),
('K76.8'),
('K76.9'),
('M06'),
('M31.5'),
('M35.1'),
('M35.3'),
('M36.0'),
('N18'),
('N19'),
('N25.0'),
('P29.0'),
('Z94.0'),
('Z94.4'),
('Z95.8'),
('Z95.9'),
('Z99.2'),
('A41'),
('B18'),
('B20'),
('B21'),
('B22'),
('B24'),
('C00'),
('C01'),
('C02'),
('C03'),
('C04'),
('C05'),
('C0-6'),
('C06'),
('C07'),
('C08'),
('C09'),
('C10'),
('C11'),
('C12'),
('C13'),
('C14'),
('C15'),
('C16'),
('C17'),
('C18'),
('C19'),
('C20'),
('C21'),
('C22'),
('C23'),
('C24'),
('C25'),
('C26'),
('C30'),
('C31'),
('C32'),
('C33'),
('C34'),
('C34'),
('C37'),
('C38'),
('C39'),
('C40'),
('C41'),
('C43'),
('C45'),
('C46'),
('C47'),
('C48'),
('C49'),
('C50'),
('C51'),
('C52'),
('C53'),
('C54'),
('C55'),
('C56'),
('C57'),
('C58'),
('C60'),
('C61'),
('C62'),
('C63'),
('C64'),
('C65'),
('C66'),
('C67'),
('C68'),
('C69'),
('C70'),
('C70'),
('C71'),
('C71'),
('C72'),
('C72'),
('C73'),
('C73'),
('C74'),
('C74'),
('C75'),
('C75'),
('C76'),
('C77'),
('C77'),
('C78'),
('C78'),
('C79'),
('C79'),
('C80'),
('C81'),
('C81'),
('C82'),
('C82'),
('C83'),
('C83'),
('C84'),
('C84'),
('C85'),
('C85'),
('C86'),
('C87'),
('C88'),
('C9'),
('C90'),
('C91'),
('C92'),
('C93'),
('C94'),
('C94'),
('C95'),
('C96'),
('C97'),
('E10.0'),
('E10.2'),
('E10.3'),
('E10.4'),
('E10.5'),
('E11'),
('E11.2'),
('E11.3'),
('E11.4'),
('E11.5'),
('E12'),
('E12.2'),
('E12.3'),
('E12.4'),
('E12.5'),
('E13'),
('E13.2'),
('E13.3'),
('E13.4'),
('E13.5'),
('E14'),
('E14.2'),
('E14.3'),
('E14.4'),
('E14.5'),
('E66'),
('E78'),
('E88.0'),
('F00'),
('F00'),
('F01'),
('F01'),
('F02'),
('F02'),
('F03'),
('F03'),
('F10.2'),
('F11'),
('F12'),
('F14'),
('F15'),
('F16'),
('F17'),
('F19'),
('G04.1'),
('G45'),
('G83.4'),
('I06'),
('I09.9'),
('I10'),
('I11'),
('I11.00'),
('I11.01'),
('I12.0'),
('I15'),
('I20'),
('I21'),
('I22'),
('I23'),
('I24'),
('I25'),
('I27.8'),
('I33'),
('I34'),
('I35'),
('I36'),
('I37'),
('I38'),
('I39'),
('I42.5'),
('I42.6'),
('I42.7'),
('I42.8'),
('I42.9'),
('I44.2'),
('I46'),
('I47'),
('I47.2'),
('I48'),
('I49'),
('I49.0'),
('I50'),
('I50'),
('I5-9'),
('I60'),
('I61'),
('I62'),
('I63'),
('I63'),
('I64'),
('I65'),
('I66'),
('I67'),
('I68'),
('I69'),
('I70.2'),
('I70'),
('I85.0'),
('J00'),
('J01'),
('J02'),
('J03'),
('J04'),
('J05'),
('J06'),
('J09'),
('J10'),
('J10'),
('J11'),
('J11'),
('J12'),
('J12'),
('J13'),
('J13'),
('J14'),
('J14'),
('J15.0'),
('J15.1'),
('J15.2'),
('J15.3'),
('J15.4'),
('J15.5'),
('J15.6'),
('J16'),
('J16'),
('J17'),
('J17'),
('J18'),
('J18'),
('J30'),
('J40'),
('J41'),
('J42'),
('J43'),
('J44'),
('J44.1'),
('J44.10'),
('J44.11'),
('J44.12'),
('J44.13'),
('J45'),
('J46'),
('J47'),
('J60'),
('J61'),
('J62'),
('J63'),
('J64'),
('J65'),
('J66'),
('J67'),
('J98.1'),
('K25'),
('K26'),
('K27'),
('K28'),
('K70.0'),
('K70.1'),
('K70.2'),
('K70.3'),
('K71.3'),
('K71.4'),
('K71.5'),
('K76.2'),
('K76.3'),
('K76.4'),
('M05'),
('M05'),
('M06'),
('M07.0'),
('M07.1'),
('M07.2'),
('M07.3'),
('M09.0'),
('M30'),
('M32'),
('M32-35'),
('M33'),
('M34'),
('M45'),
('N03.2'),
('N03.3'),
('N03.4'),
('N03.5'),
('N03.6'),
('N03.7'),
('N05.2'),
('N05.3'),
('N05.4'),
('N05.5'),
('N05.6'),
('N05.7'),
('N17'),
('Z49.0'),
('Z49.1'),
('Z49.2');


drop table if exists asthm_copd cascade;

-- Cases with COPD between 2009 and 2019
select distinct encounterid into asthm_copd from p21.p21_diagnosis pd where icdcode ~ 'J44'
and encounterid in (select id from p21.p21_encounter pe where date_part('year', admissiondate) >2008 and date_part('year', admissiondate) < 2019)
and encounterid not like '';

-- Patients with COPD and another comorbidies
copy (
  select
    'COPD_AATM'||uuid_id patid,
    date_trunc('month',admissiondate)::date as admissiondate ,
    date_trunc('month', dischargedate)::date as dischargedate,
    CASE
      WHEN admissionreason::text ~~ ''::text OR admissionreason IS NULL THEN NULL::text
      ELSE lpad(admissionreason::text, 4, '0'::text)
    end as "admissionreason",
    CASE
      WHEN dischargereason::text ~~ ''::text THEN NULL::character varying
      WHEN length(dischargereason::text) < 2 THEN (('0'::text || dischargereason::text) || '9'::text)::character varying
      WHEN length(dischargereason::text) = 2 AND dischargereason::text ~ '^\d{2}$'::text THEN
        CASE
          WHEN dischargereason::integer <= 10 OR dischargereason::integer = 15 THEN dischargereason::text || '9'::text
           WHEN dischargereason::integer <> 15 THEN '0'::text || dischargereason::text
            ELSE NULL::text
         END::character varying
         ELSE dischargereason
     END as "dischargereason",
     gender,
     ageyear / 5 * 5 as age_range,
     ventilationhours,
     icdcode icd10gm
  from p21.p21_encounter pe
  join asthm_copd ac on ac.encounterid = pe.id
  join p21.p21_diagnosis pd on pe.id = pd.encounterid
  join diz_intern.diziduuid d on d.fall_pat_nummer = pe.patientid
  join dativa_study1_icd dsi on pd.icdcode ~ dsi.icd
    union
  select
    'COPD_AATM'||uuid_id patid,
    date_trunc('month',admissiondate)::date as admissiondate ,
    date_trunc('month', dischargedate)::date as dischargedate,
    CASE
      WHEN admissionreason::text ~~ ''::text OR admissionreason IS NULL THEN NULL::text
      ELSE lpad(admissionreason::text, 4, '0'::text)
    end as "admissionreason",
    CASE
      WHEN dischargereason::text ~~ ''::text THEN NULL::character varying
      WHEN length(dischargereason::text) < 2 THEN (('0'::text || dischargereason::text) || '9'::text)::character varying
      WHEN length(dischargereason::text) = 2 AND dischargereason::text ~ '^\d{2}$'::text THEN
        CASE
          WHEN dischargereason::integer <= 10 OR dischargereason::integer = 15 THEN dischargereason::text || '9'::text
           WHEN dischargereason::integer <> 15 THEN '0'::text || dischargereason::text
            ELSE NULL::text
         END::character varying
         ELSE dischargereason
     END as "dischargereason",
    gender,
    ageyear / 5 * 5 as age_range,
    ventilationhours,
    icdcode2 icd10gm
  from p21.p21_encounter pe
  join asthm_copd ac on ac.encounterid = pe.id
  join p21.p21_diagnosis pd on pe.id = pd.encounterid
  join diz_intern.diziduuid d on d.fall_pat_nummer = pe.patientid
  join dativa_study1_icd dsi on pd.icdcode2 ~ dsi.icd
) to '/media/db/cdw_database/asthma_copd-diagnosis.csv' delimiter ',' csv header;
