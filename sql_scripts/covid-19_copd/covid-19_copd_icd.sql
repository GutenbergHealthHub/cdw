-- Table with icd10gm von covid and copd patients
drop table if exists covid_19_copd_icd;
create table covid_19_copd_icd(
  icd varchar
);

insert into covid_19_copd_icd
values
('U07.1'),
('U07.2'),
('U08  '),
('U08.9'),
('B20'),
('B21'),
('B22'),
('B23'),
('B24'),
('C00'),
('C01'),
('C02'),
('C03'),
('C04'),
('C05'),
('C06'),
('C07'),
('C08'),
('C09'),
('C10'),
('C11'),
('C12'),
('C13'),
('C14'),
('C15'),
('C16'),
('C17'),
('C18'),
('C19'),
('C20'),
('C21'),
('C22'),
('C23'),
('C24'),
('C25'),
('C26'),
('C30'),
('C31'),
('C32'),
('C33'),
('C34'),
('C35'),
('C36'),
('C37'),
('C38'),
('C39'),
('C40'),
('C41'),
('C43'),
('C44'),
('C45'),
('C46'),
('C47'),
('C48'),
('C49'),
('C50'),
('C51'),
('C52'),
('C53'),
('C54'),
('C55'),
('C56'),
('C57'),
('C58'),
('C60'),
('C61'),
('C62'),
('C63'),
('C64'),
('C65'),
('C66'),
('C67'),
('C68'),
('C69'),
('C70'),
('C71'),
('C72'),
('C73'),
('C74'),
('C75'),
('C76'),
('C77'),
('C78'),
('C79'),
('C80'),
('C81'),
('C82'),
('C83'),
('C84'),
('C85'),
('C86'),
('C87'),
('C88'),
('C89'),
('C90'),
('C91'),
('C92'),
('C93'),
('C94'),
('C95'),
('C96'),
('D70'),
('D71'),
('D80'),
('D81'),
('D82'),
('D83'),
('D84'),
('D90'),
('E10'),
('E11'),
('E12'),
('E13'),
('E14'),
('E20'),
('E20'),
('E21'),
('E21'),
('E22'),
('E22'),
('E23'),
('E23'),
('E24'),
('E24'),
('E25'),
('E25'),
('E26'),
('E26'),
('E27'),
('E27'),
('E28'),
('E28'),
('E29'),
('E29'),
('E31'),
('E34'),
('G00'),
('G01'),
('G02'),
('G03'),
('G04'),
('G05'),
('G06'),
('G07'),
('G08'),
('G09'),
('G10'),
('G11'),
('G12'),
('G13'),
('G14'),
('G20'),
('G21'),
('G22'),
('G23'),
('G24'),
('G25'),
('G26'),
('G30'),
('G31'),
('G32'),
('G35'),
('G36'),
('G37'),
('G40'),
('G41'),
('G42'),
('G43'),
('G44'),
('G45'),
('G46'),
('G47'),
('G50'),
('G51'),
('G52'),
('G53'),
('G54'),
('G55'),
('G56'),
('G57'),
('G58'),
('G59'),
('G60'),
('G61'),
('G62'),
('G63'),
('G64'),
('G65'),
('G70'),
('G71'),
('G72'),
('G73'),
('G80'),
('G81'),
('G82'),
('G83'),
('G89'),
('G90'),
('G91'),
('G92'),
('G93'),
('G94'),
('G95'),
('G96'),
('G97'),
('G98'),
('G99'),
('I10'),
('I11'),
('I12'),
('I13'),
('I14'),
('I15'),
('I20'),
('I21'),
('I22'),
('I23'),
('I24'),
('I25'),
('I60'),
('I61'),
('I62'),
('I63'),
('I64'),
('I65'),
('I66'),
('I67'),
('I68'),
('I69'),
('J41'),
('J42'),
('J43'),
('J44'),
('J44.0'),
('J44.1'),
('J44.8'),
('J44.9'),
('J47'),
('J60'),
('J61'),
('J62'),
('J63'),
('J64'),
('J65'),
('J66'),
('J67'),
('J84.1'),
('K70'),
('K71'),
('K73'),
('K74'),
('K75'),
('K76'),
('K77'),
('N18.2'),
('N18.3'),
('N18.4'),
('N18.5'),
('N18.89'),
('N18.9');


-- Cases with COPD and covid in 2020 or 2021
drop table if exists covid_copd_caseid cascade;
select distinct encounterid into covid_copd_caseid from p21.p21_diagnosis pd 
where (icdcode ~ 'J44|U07\.[12]|U08' or icdcode2 ~ 'U07\.[12]|U08')
and encounterid in (select id from p21.p21_encounter pe where date_part('year', admissiondate) between 2020 and  2021)
and encounterid not like '';

-- Patients with COVID-19 and COPD and another comorbidies
copy (
  select
    'COVID_19_COPD'||uuid_id patid,
    date_trunc('month',admissiondate)::date as admissiondate ,
    date_trunc('month', dischargedate)::date as dischargedate,
    CASE
      WHEN admissionreason::text ~~ ''::text OR admissionreason IS NULL THEN NULL::text
      ELSE lpad(admissionreason::text, 4, '0'::text)
    end as "admissionreason",
    CASE
      WHEN dischargereason::text ~~ ''::text THEN NULL::character varying
      WHEN length(dischargereason::text) < 2 THEN (('0'::text || dischargereason::text) || '9'::text)::character varying
      WHEN length(dischargereason::text) = 2 AND dischargereason::text ~ '^\d{2}$'::text THEN
        CASE
          WHEN dischargereason::integer <= 10 OR dischargereason::integer = 15 THEN dischargereason::text || '9'::text
           WHEN dischargereason::integer <> 15 THEN '0'::text || dischargereason::text
            ELSE NULL::text
         END::character varying
         ELSE dischargereason
     END as "dischargereason",
     gender,
     ageyear / 5 * 5 as age_range,
     ventilationhours,
     icdcode icd10gm
  from p21.p21_encounter pe
  join covid_copd_caseid ac on ac.encounterid = pe.id
  join p21.p21_diagnosis pd on pe.id = pd.encounterid
  join diz_intern.diziduuid d on d.fall_pat_nummer = pe.patientid
  join covid_19_copd_icd dsi on pd.icdcode ~ dsi.icd
    union
  select
    'COVID_19_COPD'||uuid_id patid,
    date_trunc('month',admissiondate)::date as admissiondate ,
    date_trunc('month', dischargedate)::date as dischargedate,
    CASE
      WHEN admissionreason::text ~~ ''::text OR admissionreason IS NULL THEN NULL::text
      ELSE lpad(admissionreason::text, 4, '0'::text)
    end as "admissionreason",
    CASE
      WHEN dischargereason::text ~~ ''::text THEN NULL::character varying
      WHEN length(dischargereason::text) < 2 THEN (('0'::text || dischargereason::text) || '9'::text)::character varying
      WHEN length(dischargereason::text) = 2 AND dischargereason::text ~ '^\d{2}$'::text THEN
        CASE
          WHEN dischargereason::integer <= 10 OR dischargereason::integer = 15 THEN dischargereason::text || '9'::text
           WHEN dischargereason::integer <> 15 THEN '0'::text || dischargereason::text
            ELSE NULL::text
         END::character varying
         ELSE dischargereason
     END as "dischargereason",
    gender,
    ageyear / 5 * 5 as age_range,
    ventilationhours,
    icdcode2 icd10gm
  from p21.p21_encounter pe
  join covid_copd_caseid ac on ac.encounterid = pe.id
  join p21.p21_diagnosis pd on pe.id = pd.encounterid
  join diz_intern.diziduuid d on d.fall_pat_nummer = pe.patientid
  join covid_19_copd_icd dsi on pd.icdcode2 ~ dsi.icd
) to '/media/db/cdw_database/covid_19_copd-diagnosis.csv' delimiter ',' csv header;
